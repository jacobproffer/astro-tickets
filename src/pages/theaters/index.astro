---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import Section from "@components/Section.astro";
import PageHeader from "@components/PageHeader.astro";

const tickets = await getCollection("tickets");

// Group tickets by theater and count them
const theaterCounts = tickets.reduce(
  (acc, ticket) => {
    const theater = ticket.data.theater;
    acc[theater] = (acc[theater] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>
);

// Convert to array and sort by count (descending), then alphabetically
const sortedTheaters = Object.entries(theaterCounts).sort(
  ([a, countA], [b, countB]) => {
    if (countB !== countA) {
      return countB - countA; // Sort by count descending
    }
    return a.localeCompare(b); // Then alphabetically
  }
);

const totalTickets = tickets.length;
const pageTitle = "Movie Theaters";
const pageDescription = `Browse movie tickets by theater. ${totalTickets} total tickets across ${sortedTheaters.length} different theaters.`;

// Function to create URL-friendly theater slug
function createTheaterSlug(theater: string): string {
  return theater.toLowerCase().replace(/[^a-z0-9]/g, "-");
}
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <Section
    headline={`Movie Theaters (${sortedTheaters.length})`}
    headingLevel={1}
    transition:name="theaters-section"
  >
    <PageHeader
      title="theaters"
      description={`Browse ${totalTickets} movie tickets organized by theater across ${sortedTheaters.length} different venues.`}
    />

    <ol
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 border-t border-l border-dashed border-black"
    >
      {
        sortedTheaters.map(([theater, count]) => (
          <li class="relative h-full">
            <a
              href={`/theaters/${createTheaterSlug(theater)}/`}
              class="block h-full"
            >
              <div class="h-full bg-card p-4 border-r border-b border-dashed border-black hover:bg-green transition-colors">
                {/* Theater Header */}
                <div class="text-xs uppercase tracking-wide text-black font-mono">
                  <div>
                    <span class="sr-only">Theater</span>
                    Movie Theater
                  </div>
                </div>

                {/* Theater Name */}
                <h2 class="text-2xl font-bold leading-tight -mx-2 px-2 py-1 mb-2">
                  {theater}
                </h2>

                {/* Theater Details */}
                <div class="space-y-4 text-sm">
                  {/* Movies Count and Percentage */}
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="text-xs uppercase tracking-wide block mb-1">
                        Movies
                      </span>
                      <span class="font-medium">
                        {count} {count === 1 ? "ticket" : "tickets"}
                      </span>
                    </div>
                    <div class="text-right">
                      <span class="text-xs uppercase tracking-wide block mb-1">
                        Share
                      </span>
                      <span class="px-2 py-1 border border-dashed text-xs font-bold">
                        {Math.round((count / totalTickets) * 100)}%
                      </span>
                    </div>
                  </div>

                  {/* Footer */}
                  <div class="pt-3 border-t border-dashed border-black">
                    <div class="flex justify-between items-center">
                      <span
                        class="text-xs uppercase tracking-wide font-mono"
                        aria-hidden="true"
                      >
                        View Theater
                      </span>
                      <span class="text-lg font-bold text-black">â†’</span>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          </li>
        ))
      }
    </ol>
  </Section>
</BaseLayout>
