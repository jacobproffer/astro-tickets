---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import PageHeader from "@components/PageHeader.astro";
import Section from "@components/Section.astro";
import TicketGrid from "@components/TicketGrid.astro";

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const tickets = await getCollection("tickets");

  // Sort tickets by date in descending order (newest first)
  const sortedTickets = tickets.sort((a, b) => {
    const dateA = new Date(a.data.date);
    const dateB = new Date(b.data.date);
    return dateB.getTime() - dateA.getTime();
  });

  return paginate(sortedTickets, { pageSize: 24 });
}

interface Props {
  page: {
    data: CollectionEntry<"tickets">[];
    url: {
      current: string;
      next?: string;
      prev?: string;
    };
    start: number;
    end: number;
    size: number;
    total: number;
    currentPage: number;
    lastPage: number;
  };
}

const { page } = Astro.props;
const pageTitle = `Tickets - Page ${page.currentPage}`;
const pageDescription = `Browse movie tickets ${page.start + 1}-${page.end + 1} of ${page.total} total tickets collected.`;
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <Section headline={`All Tickets (${page.total})`} headingLevel={1}>
    <PageHeader
      title="tickets"
      showRange={{ start: page.start, end: page.end, total: page.total }}
      showPagination={{ current: page.currentPage, last: page.lastPage }}
      description="tickets"
    />

    <TicketGrid tickets={page.data} transitionName="tickets-grid" />

    <nav
      aria-label="Pagination Navigation"
      class="flex items-center justify-between pb-4 border-b border-solid"
    >
      <div
        class="flex flex-1 flex-col sm:flex-row sm:items-center justify-between"
      >
        <div>
          <p>
            Showing <span class="font-medium">{page.start + 1}</span> to{" "}
            <span class="font-medium">{page.end + 1}</span> of{" "}
            <span class="font-medium">{page.total}</span> tickets
          </p>
        </div>

        <div class="flex items-center">
          {
            page.url.prev && (
              <a
                href={page.url.prev}
                class="relative inline-flex items-center border-t border-l border-b border-solid px-4 py-3 text-black hover:bg-gray-100 focus:z-20 focus:outline-4 focus:outline-black focus:-outline-offset-2 transition-colors"
              >
                Previous
              </a>
            )
          }

          <span
            class="relative inline-flex items-center px-4 py-3 border border-solid z-10 text-black bg-green focus:z-20"
          >
            {page.currentPage}
          </span>

          {
            page.lastPage > 1 && (
              <span class="relative inline-flex items-center px-4 py-3">
                of {page.lastPage}
              </span>
            )
          }

          {
            page.url.next && (
              <a
                href={page.url.next}
                class="relative inline-flex items-center border border-solid px-4 py-3 text-black hover:bg-gray-100 focus:z-20 focus:outline-4 focus:outline-black focus:-outline-offset-2 transition-colors"
              >
                Next
              </a>
            )
          }
        </div>
      </div>
    </nav>
  </Section>
</BaseLayout>
