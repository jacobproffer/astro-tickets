---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/Section.astro";
import Ticket from "../../components/Ticket.astro";
import Hero from "../../components/Hero.astro";

export async function getStaticPaths({ paginate }: { paginate: any }) {
  const tickets = await getCollection("tickets");

  // Sort tickets by date in descending order (newest first)
  const sortedTickets = tickets.sort((a, b) => {
    const dateA = new Date(a.data.date);
    const dateB = new Date(b.data.date);
    return dateB.getTime() - dateA.getTime();
  });

  return paginate(sortedTickets, { pageSize: 24 });
}

interface Props {
  page: {
    data: CollectionEntry<"tickets">[];
    url: {
      current: string;
      next?: string;
      prev?: string;
    };
    start: number;
    end: number;
    size: number;
    total: number;
    currentPage: number;
    lastPage: number;
  };
}

const { page } = Astro.props;
const pageTitle = `Tickets - Page ${page.currentPage}`;
const pageDescription = `Browse movie tickets ${page.start + 1}-${page.end + 1} of ${page.total} total tickets collected.`;
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <Hero />
  <Section headline={`All Tickets (${page.total})`}>
    <div class="mb-6">
      <div class="flex items-center justify-between text-sm">
        <span>
          Showing {page.start + 1}-{page.end + 1} of {page.total} tickets
        </span>
        <span>
          Page {page.currentPage} of {page.lastPage}
        </span>
      </div>
    </div>

    <ol
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 gap-4 mb-8"
      transition:name="tickets-grid"
    >
      {
        page.data.map((ticket) => (
          <li>
            <Ticket
              title={ticket.data.title}
              theater={ticket.data.theater}
              time={ticket.data.date.toISOString().split("T")[0]}
              price={ticket.data.price}
              rating={ticket.data.rating}
            />
          </li>
        ))
      }
    </ol>

    <!-- Pagination Navigation -->
    <nav
      aria-label="Pagination Navigation"
      class="flex items-center justify-between border-t border-gray-700 pt-6"
    >
      <div class="flex flex-1 justify-between sm:hidden">
        {
          page.url.prev && (
            <a
              href={page.url.prev}
              class="relative inline-flex items-center rounded-md border border-gray-600 bg-gray-800 px-4 py-2 text-sm font-medium text-black hover:bg-gray-700"
            >
              Previous
            </a>
          )
        }
        {
          page.url.next && (
            <a
              href={page.url.next}
              class="relative ml-3 inline-flex items-center rounded-md border border-gray-600 bg-gray-800 px-4 py-2 text-sm font-medium text-black hover:bg-gray-700"
            >
              Next
            </a>
          )
        }
      </div>

      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm">
            Showing <span class="font-medium">{page.start + 1}</span> to{" "}
            <span class="font-medium">{page.end + 1}</span> of{" "}
            <span class="font-medium">{page.total}</span> tickets
          </p>
        </div>

        <div class="flex items-center space-x-2">
          {
            page.url.prev && (
              <a
                href={page.url.prev}
                class="relative inline-flex items-center rounded-l-md border border-gray-600 bg-gray-800 px-2 py-2 text-sm font-medium text-black hover:bg-gray-700 focus:z-20"
              >
                <span class="sr-only">Previous</span>←
              </a>
            )
          }

          <span
            class="relative inline-flex items-center px-4 py-2 text-sm font-medium border z-10 bg-blue-600 border-blue-600 text-black focus:z-20"
          >
            {page.currentPage}
          </span>

          {
            page.lastPage > 1 && (
              <span class="relative inline-flex items-center px-2 py-2 text-sm font-medium">
                of {page.lastPage}
              </span>
            )
          }

          {
            page.url.next && (
              <a
                href={page.url.next}
                class="relative inline-flex items-center rounded-r-md border border-gray-600 bg-gray-800 px-2 py-2 text-sm font-medium text-black hover:bg-gray-700 focus:z-20"
              >
                <span class="sr-only">Next</span>→
              </a>
            )
          }
        </div>
      </div>
    </nav>
  </Section>
</BaseLayout>
