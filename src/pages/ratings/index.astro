---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/Section.astro";
import PageHeader from "../../components/PageHeader.astro";

const tickets = await getCollection("tickets");

// Count tickets by rating
const ratingCounts = tickets.reduce(
  (acc, ticket) => {
    const rating = ticket.data.rating;
    acc[rating] = (acc[rating] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>
);

// Sort ratings in a logical order (G, PG, PG-13, R, etc.)
const ratingOrder = ["G", "PG", "PG-13", "R", "NC-17", "NR", "Unrated"];
const sortedRatings = Object.entries(ratingCounts).sort(([a], [b]) => {
  const aIndex = ratingOrder.indexOf(a);
  const bIndex = ratingOrder.indexOf(b);

  // If both ratings are in the order array, sort by their position
  if (aIndex !== -1 && bIndex !== -1) {
    return aIndex - bIndex;
  }

  // If only one is in the order array, prioritize it
  if (aIndex !== -1) return -1;
  if (bIndex !== -1) return 1;

  // If neither is in the order array, sort alphabetically
  return a.localeCompare(b);
});

const totalTickets = tickets.length;
const pageTitle = "Movie Ratings";
const pageDescription = `Browse movie tickets by rating. ${totalTickets} total tickets across ${sortedRatings.length} different ratings.`;

// Function to create URL-friendly rating slug
function createRatingSlug(rating: string): string {
  return rating.toLowerCase().replace(/[^a-z0-9]/g, "-");
}
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <Section
    headline={`Movie Ratings (${sortedRatings.length})`}
    headingLevel={1}
    transition:name="ratings-section"
  >
    <PageHeader
      title="ratings"
      description={`Browse ${totalTickets} movie tickets organized by rating across ${sortedRatings.length} different classifications.`}
    />

    <ol
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 border-t border-l border-dashed border-black"
    >
      {
        sortedRatings.map(([rating, count]) => (
          <li class="relative h-full">
            <a
              href={`/ratings/${createRatingSlug(rating)}/`}
              class="block h-full"
            >
              <div class="h-full bg-card p-4 border-r border-b border-dashed border-black hover:bg-green transition-colors">
                {/* Rating Header */}
                <div class="text-xs uppercase tracking-wide text-black font-mono">
                  <div>
                    <span class="sr-only">Rating</span>
                    Movie Rating
                  </div>
                </div>

                {/* Rating Classification */}
                <h2 class="text-2xl font-bold leading-tight -mx-2 px-2 py-1 mb-2">
                  {rating}
                </h2>

                {/* Rating Details */}
                <div class="space-y-4 text-sm">
                  {/* Movies Count and Percentage */}
                  <div class="flex justify-between items-center">
                    <div>
                      <span class="text-xs uppercase tracking-wide block mb-1">
                        Movies
                      </span>
                      <span class="font-medium">
                        {count} {count === 1 ? "ticket" : "tickets"}
                      </span>
                    </div>
                    <div class="text-right">
                      <span class="text-xs uppercase tracking-wide block mb-1">
                        Share
                      </span>
                      <span class="px-2 py-1 border border-dashed text-xs font-bold">
                        {Math.round((count / totalTickets) * 100)}%
                      </span>
                    </div>
                  </div>

                  {/* Footer */}
                  <div class="pt-3 border-t border-dashed border-black">
                    <div class="flex justify-between items-center">
                      <span
                        class="text-xs uppercase tracking-wide font-mono"
                        aria-hidden="true"
                      >
                        View Rating
                      </span>
                      <span class="text-lg font-bold text-black">â†’</span>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          </li>
        ))
      }
    </ol>
  </Section>
</BaseLayout>
