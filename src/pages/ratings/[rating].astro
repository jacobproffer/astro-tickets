---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/Section.astro";
import TicketGrid from "../../components/TicketGrid.astro";
import PageHeader from "../../components/PageHeader.astro";

export async function getStaticPaths() {
  const tickets = await getCollection("tickets");

  // Get all unique ratings
  const ratings = [...new Set(tickets.map((ticket) => ticket.data.rating))];

  return ratings.map((rating) => ({
    params: { rating: rating.toLowerCase().replace(/[^a-z0-9]/g, "-") },
    props: {
      tickets: tickets.filter((ticket) => ticket.data.rating === rating),
      rating,
    },
  }));
}

const { tickets, rating } = Astro.props;
const sortedTickets = tickets.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

const pageTitle = `${rating} Rated Movies`;
const pageDescription = `Browse ${tickets.length} ${rating} rated movie tickets from my collection.`;
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <Section
    headline={`${rating} Rated Movies (${tickets.length})`}
    headingLevel={1}
  >
    <PageHeader
      title="movies"
      count={tickets.length}
      description={`Showing all ${tickets.length} ${rating} rated movies`}
    />

    <TicketGrid tickets={sortedTickets} transitionName="tickets-grid" />
  </Section>
</BaseLayout>
