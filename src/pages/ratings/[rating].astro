---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Section from "../../components/Section.astro";
import Ticket from "../../components/Ticket.astro";

export async function getStaticPaths() {
  const tickets = await getCollection("tickets");

  // Get all unique ratings
  const ratings = [...new Set(tickets.map((ticket) => ticket.data.rating))];

  return ratings.map((rating) => ({
    params: { rating: rating.toLowerCase().replace(/[^a-z0-9]/g, "-") },
    props: {
      tickets: tickets.filter((ticket) => ticket.data.rating === rating),
      rating,
    },
  }));
}

const { tickets, rating } = Astro.props;
const sortedTickets = tickets.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

const pageTitle = `${rating} Rated Movies`;
const pageDescription = `Browse ${tickets.length} ${rating} rated movie tickets from my collection.`;
---

<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <Section
    headline={`${rating} Rated Movies (${tickets.length})`}
    headingLevel={1}
  >
    <h2>
      Showing all {tickets.length}
      {rating} rated movies
    </h2>

    <ol
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 border-t border-l border-dashed border-black"
      transition:name="tickets-grid"
    >
      {
        sortedTickets.map((ticket) => (
          <li>
            <Ticket
              title={ticket.data.title}
              theater={ticket.data.theater}
              time={ticket.data.date.toISOString().split("T")[0]}
              price={ticket.data.price}
              rating={ticket.data.rating}
              international={ticket.data.international}
            />
          </li>
        ))
      }
    </ol>
  </Section>
</BaseLayout>
