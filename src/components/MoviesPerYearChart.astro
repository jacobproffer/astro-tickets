---
import type { CollectionEntry } from "astro:content";

interface Props {
  tickets: CollectionEntry<"tickets">[];
}

const { tickets: allTickets } = Astro.props;

// Count movies per year
const moviesByYear = allTickets.reduce(
  (acc, ticket) => {
    const year = ticket.data.date.getFullYear();
    acc[year] = (acc[year] || 0) + 1;
    return acc;
  },
  {} as Record<number, number>,
);

// Convert to array and sort by year
const data = Object.entries(moviesByYear)
  .map(([year, count]) => ({ year: +year, count }))
  .sort((a, b) => a.year - b.year);

// Calculate some stats
const totalMovies = allTickets.length;
const yearNumbers = data.map((d) => d.year);
const years =
  yearNumbers.length > 0
    ? Math.max(...yearNumbers) - Math.min(...yearNumbers)
    : 0;
const avgPerYear = years === 0 ? "0.0" : (totalMovies / years).toFixed(1);
---

<div
  class="flex flex-col gap-2 py-4 lg:pl-4 max-lg:border-t max-lg:border-b max-lg:border-solid lg:border-b"
>
  <h2 class="text-xl md:text-2xl">Movies Per Year</h2>
  <p>
    {totalMovies} movies across {years} years (avg: {avgPerYear}/year)
  </p>
  <figure
    id="movies-chart"
    class="w-full overflow-x-auto"
    aria-label="Movies per year chart"
  >
  </figure>
</div>

<script>
  import * as Plot from "@observablehq/plot";

  // Parse data once at module level
  const dataElement = document.getElementById("chart-data");
  if (!dataElement?.textContent) {
    console.error("MoviesPerYearChart: chart-data element not found or empty");
  }

  let chartData: Array<{ year: number; count: number }> = [];
  try {
    chartData = JSON.parse(dataElement?.textContent || "[]");
    if (!Array.isArray(chartData) || chartData.length === 0) {
      console.warn("MoviesPerYearChart: No chart data available");
    }
  } catch (error) {
    console.error("MoviesPerYearChart: Failed to parse chart data", error);
  }

  let resizeListener: (() => void) | null = null;

  function initChart() {
    const container = document.getElementById("movies-chart");

    // Early return if container doesn't exist
    if (!container) return;

    function createChart() {
      // Clear existing chart
      container!.innerHTML = "";

      const chartWidth = container!.clientWidth;

      // Create the plot with line chart for all screen sizes
      const plot = Plot.plot({
        width: chartWidth,
        marginBottom: 50,
        x: {
          label: "Year",
          tickFormat: (d) => String(d),
        },
        y: {
          label: "Number of Movies",
          grid: true,
        },
        marks: [
          Plot.line(chartData, {
            x: "year",
            y: "count",
            stroke: "#121212",
            strokeWidth: 2,
            tip: {
              format: {
                x: (d) => String(d),
              },
            },
          }),
          Plot.dot(chartData, {
            x: "year",
            y: "count",
            fill: "#2e160e",
            r: 3,
          }),
          Plot.ruleY([0]),
        ],
      });

      container!.appendChild(plot);
    }

    // Create chart on load
    createChart();

    // Remove old resize listener before adding a new one
    if (resizeListener) {
      window.removeEventListener("resize", resizeListener);
    }

    // Store and add new resize listener
    resizeListener = createChart;
    window.addEventListener("resize", resizeListener);
  }

  // Run on initial load
  initChart();

  // Re-run after view transitions
  document.addEventListener("astro:page-load", initChart);
</script>

<script
  type="application/json"
  id="chart-data"
  set:html={JSON.stringify(data)}
/>
