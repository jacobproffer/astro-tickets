---
import { getCollection } from "astro:content";
import Section from "@components/Section.astro";
import ExternalLink from "@components/ExternalLink.astro";
import MoviesPerYearChart from "@components/MoviesPerYearChart.astro";
import RatingsChart from "@components/RatingsChart.astro";
import TheatersChart from "@components/TheatersChart.astro";

// Get all tickets and calculate statistics
const tickets = await getCollection("tickets");
const totalTickets = tickets.length;

// Calculate date range
const dates = tickets
  .map((t) => new Date(t.data.date))
  .sort((a, b) => a.getTime() - b.getTime());
const firstTicketDate = dates[0];
const lastTicketDate = dates[dates.length - 1];
const yearsCollecting =
  lastTicketDate.getFullYear() - firstTicketDate.getFullYear();

// Get unique theaters
const uniqueTheaters = [...new Set(tickets.map((t) => t.data.theater))];
const totalTheaters = uniqueTheaters.length;

// Calculate total spent
const totalSpent = tickets.reduce((sum, ticket) => sum + ticket.data.price, 0);

// Get most visited theater
const theaterCounts = tickets.reduce(
  (acc, ticket) => {
    acc[ticket.data.theater] = (acc[ticket.data.theater] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>,
);
const mostVisitedTheater = Object.entries(theaterCounts).sort(
  (a, b) => b[1] - a[1],
)[0];

// Get rating distribution
const ratingCounts = tickets.reduce(
  (acc, ticket) => {
    acc[ticket.data.rating] = (acc[ticket.data.rating] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>,
);

// Count international tickets
const internationalCount = tickets.filter((t) => t.data.international).length;
---

<Section headline="About Deadman's Brew">
  <div class="grid border-t border-b border-solid lg:grid-cols-[1fr_2fr]">
    <div
      class="prose prose-lg pt-4 max-lg:pb-4 lg:pr-4 lg:border-r lg:border-b lg:pb-4 border-solid"
    >
      <p class="text-lg leading-6">
        Deadman's Brew is the movie ticket collection of Jacob Proffer,
        documenting <strong>{yearsCollecting} years</strong> of cinema experiences
        across
        <strong>{totalTheaters} different theaters</strong>. Starting with {
          firstTicketDate.toLocaleDateString("en-US", {
            month: "long",
            year: "numeric",
          })
        }, this collection has grown to <strong>{totalTickets} tickets</strong>,
        capturing memories from
        {
          internationalCount > 0
            ? ` both domestic and international venues`
            : ` theaters across the United States`
        }.
      </p>

      <h2 class="text-xl md:text-2xl mt-4 mb-4">Collection Highlights</h2>
      <ul>
        <li><strong>{totalTickets}</strong> total movie tickets</li>
        <li><strong>{totalTheaters}</strong> unique theaters visited</li>
        <li>
          <strong
            >${
              totalSpent.toLocaleString("en-US", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })
            }</strong
          > spent on tickets over the years
        </li>
        <li>
          <strong>{mostVisitedTheater[0]}</strong> is the most frequented theater
          with {mostVisitedTheater[1]} visits
        </li>
        {
          internationalCount > 0 && (
            <li>
              <strong>{internationalCount}</strong> international{" "}
              {internationalCount === 1 ? "ticket" : "tickets"} from theaters
              abroad
            </li>
          )
        }
      </ul>
      <h2 class="text-xl md:text-2xl mt-4 mb-4">Built With</h2>
      <p class="text-lg leading-6">
        <p>
          This site is built by <ExternalLink
            url="https://proffer.dev/"
            title="Jacob Proffer"
          /> with <ExternalLink url="https://astro.build/" title="Astro" />, <ExternalLink
            url="https://tailwindcss.com/"
            title="Tailwind CSS"
          />, <ExternalLink
            url="https://observablehq.com/plot/"
            title="Observable Plot"
          />, and <ExternalLink
            url="https://www.typescriptlang.org/"
            title="TypeScript"
          />.
        </p>
      </p>
    </div>
    <MoviesPerYearChart tickets={tickets} />
    <RatingsChart tickets={tickets} />
    <TheatersChart tickets={tickets} />
  </div>
</Section>
